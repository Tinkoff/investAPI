#Сервис получения информации о портфеле по конкретному счёту

##Получение списка операций по счёту

В процессе работы торговому роботу требуется получать информацию об операциях по счёту. Например, чтобы
корректно рассчитывать доходности и собирать статистику своей работы. Для реализации данных потребностей
можно использовать метод [getOperations](/investAPI/operations#getoperations), а также более новый метод [getOperationsByCursor](/investAPI/operations#getoperationsbycursor).

При работе с данными методами необходимо учитывать [особенности взаимодействия](/investAPI/operations_problems).


Метод [getOperationsByCursor](/investAPI/operations#getoperationsbycursor) является более предпочтительным для использования, возвращает список всех операций по указанному счету.
Данный метод возвращает информацию обо всех операциях, в том числе отмененных, поддерживает пагинацию и расширенную фильтрацию.
Плюс данный метод обладает всеми преимуществами метода [getOperations](/investAPI/operations#getoperations).

**Важно!!!** Метод [getOperations](/investAPI/operations#getoperations) не поддерживает опционы. Для получения информации по операциям с опционами
мы рекомендуем использовать метод [getOperationsByCursor](/investAPI/operations#getoperationsbycursor).

Для вызова данных методов во входных параметрах достаточно указать только **`account_id`**.

Метод [getOperations](/investAPI/operations#getoperations), в том числе, возвращает отменённые операции (параметр *state*), это нужно обязательно учитывать
в алгоритме работы. 

**Важно!!!** Метод [getOperations](/investAPI/operations#getoperations) возвращает только последнюю тысячу операций.

Команда TINKOFF INVEST API не рекомендует использовать метод получения операций для идентификации изменения
статусов торговых поручений, т.к. некоторые операции могут происходить с задержкой относительно реального
исполнения. Для получения статусов исполнения торговых поручений рекомендуется использовать соответствующий
stream [сервиса работы с торговыми поручениями](/investAPI/head-orders/). 

##На что нужно обратить внимание в методах получения списка операций

1. id операций могут меняться со временем. Не стоит ориентироваться на id операций, как на первичный ключ. Если у вас есть потребность перезагрузить историю операций, при повторном запросе операции, рекомендуем старые id операции удалить.
2. По инструментам, прошедшим корпоративные действия, история операций может быть не полной как в api, так и в мобильном приложении. 
Для получения точной информации рекомендуем воспользоваться [брокерским отчетом](/investAPI/operations/#getbrokerreport).



##Получение портфолио

Для получения торговым роботом текущего состояния портфеля по счёту используется метод [getPortfolio](/investAPI/operations#getportfolio).
Данный метод в отличие от метода [getPositions](/investAPI/operations#getpositions) 
возвращает также статистическую информацию по портфелю (абсолютные и относительные доходности, текущую 
стоимость активов и т.п.).

Обратите внимание, что для расчёта суммарной стоимости активов используются текущие цены биржевых
инструментов. Если торги в данный момент не ведутся, то берётся цена закрытия последней торговой 
сессии. 

**Важно!!!** в данный момент запрос портфолио по счету инвесткопилки ( "type": "ACCOUNT_TYPE_INVEST_BOX") не доступен. 

В данный метод добавлен булев параметр `blocked`, принимающий значение *true*, если инструмент заблокирован депозитарием.

**Значения средних цен покупки инструментов (параметры *average_position_price*, *average_position_price_pt* и 
*average_position_price_fifo*) рассчитываются асинхронно. Возможна задержка в пересчёте до одной секунды.**


Параметр *average_position_price* - Средневзвешенная цена позиции.

Параметр *average_position_price_fifo* - Средняя цена позиции по методу FIFO. 

Более подробно о методах расчета с примерами можно почитать на сайте [Тинькофф](https://www.tinkoff.ru/help/invest-educate/yield-analysis/about/math-method/).

##Получение списка позиций портфеля по счёту

Для принятия решений торговому роботу требуется получать список актуальных позиций в портфеле, т.е. 
количество ценных бумаг, валютных позиций по счёту, включая заблокированные средства. Для этого используется
метод [getPositions](/investAPI/operations#getpositions). Команда TINKOFF 
INVEST API рекомендует использовать именно этот метод, когда требуется получить актуальный список позиций, 
т.к. он является более быстрым и "лёгким" по сравнению с методом получения портфолио. 

В данном методе также возвращается тип инструмента для списка ценно-бумажных позиций портфеля в параметре `instrument_type`.

В данный метод добавлен булев параметр `exchange_blocked`, принимающий значение *true,* если инструмент заблокирован депозитарием.

В метод [getPositions](/investAPI/operations#getpositions) добавлен массив опционов в портфеле.

**Важно!!!**. Данный метод не возвращает объём средств, заблокированных под гарантийное обеспечение фьючерсов. Для 
получения этой информации воспользуйтесь методом [getWithdrawLimits](/investAPI/operations#getwithdrawlimits). 

##Получение доступного остатка для вывода денежных средств

Метод [getWithdrawLimits](/investAPI/operations#getwithdrawlimits) позволяет в 
удобном виде получить доступный для вывода баланс денежных средств, а также количество заблокированных 
валютных позиций. 

##Получение различных отчётов 

TINKOFF INVEST API позволяет получать различные отчёты. Например, [брокерский отчёт](/investAPI/operations#getbrokerreport)
или [справка о доходах за пределами РФ](/investAPI/operations#getdividendsforeignissuer). Обратите внимание,
что операции формирования отчётов достаточно трудоёмки, поэтому существуют ограничения на период 
формирования отчёта и лимиты на количество вызовов соответствующих методов. 
Запрос справки о доходах за пределами РФ работает корректно в случае, если верхний интервал запрашиваемых дат не позднее, чем 2 рабочих дня от текущей даты.

##Стрим позиций и доходности портфеля

Для получения информации об изменении портфеля по факту совершения сделок также можно подписаться на gRPC server-side stream [PortfolioStream](/investAPI/operations/#portfoliostream).
Стрим позиций и доходностей портфеля возвращает статистическую информацию по портфелю (абсолютные и относительные доходности, текущую
стоимость активов и т.п.).

Средневзвешенная цена позиции, текущая рассчитанная доходность, текущая цена инструмента, средняя цена лота в позиции по методу FIFO - 
возвращаются в валюте инструмента.

Средняя цена лота в позиции в пунктах (для фьючерсов) - возвращает количество в пунктах. 

##Стрим изменения позиций портфеля

[PositionsStream](/investAPI/operations/#positionsstream) - gRPC server-side stream, предназначенный для получения информации по изменению позиций портфеля.

Стрим в качестве входного **необязательного** параметра принимает массив идентификаторов счетов, по которым вы хотите получать изменения позиций.

В качестве сообщений стрима приходят изменения позиций, объекты `money, securities, futures, options`, а также дата и время операции, изменившей позицию. 


###Торговые статусы инструментов и расписание торгов

Информацию о статусах инструментов и расписаниях торгов вы можете получить на странице [Торговые статусы инструментов и расписание торгов](https://tinkoff.github.io/investAPI/faq_trading_status/).

Также рекомендуем смотреть актуальную информацию по режимам и статусам торгов на сайтах [Московской биржи](https://www.moex.com/) и [СПБ биржи](https://spbexchange.ru/). 
